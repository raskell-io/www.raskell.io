<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content=dark name=theme-color><title>My OpenBSD journey: Getting it virtualized with libvirt (1) | Raskell</title><link href=https://raskell.io/rss.xml rel=alternate title=RSS type=application/rss+xml><meta content="Raskell | Tech web space curated by Raffael" property=og:site_name><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1) | Raskell" property=og:title><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1) | Raskell" itemprop=name><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1) | Raskell" name=twitter:title><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1) | Raskell" name=application-name><meta content=summary name=twitter:card><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1)" name=description><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1)" name=twitter:description><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1)" itemprop=description><meta content="My OpenBSD journey: Getting it virtualized with libvirt (1)" property=og:description><meta content=article property=og:type><meta content=Raffael property=article:author><meta content=2023-02-06 property=article:published_time><link rel="shortcut icon" href=https://raskell.io/raskell-mascot.avif type=image/x-icon><link href=https://raskell.io/style.css rel=stylesheet><script>(()=>{const a=`ThemeColorScheme`;const b=`auto`;if(!localStorage.getItem(a)){localStorage.setItem(a,b)}})()</script><script>(()=>{let d=`dark`;const a=`ThemeColorScheme`;const b=localStorage.getItem(a);const c=window.matchMedia(`(prefers-color-scheme: dark)`).matches===!0;if(b==d||b===`auto`&&c){document.documentElement.dataset.userColorScheme=d}else{document.documentElement.dataset.userColorScheme=`light`}})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=https://raskell.io> <img alt="Raskell logo" class=brand-logo src=https://raskell.io/raskell-mascot.avif> <span class=brand-text>Raskell</span> </a></div><div class=flex><a href=https://raskell.io/articles/>Articles</a><a href=https://raskell.io/projects/>Projects</a><a href=https://raskell.io/speaking/>Speaking</a><a href=https://raskell.io/about/>About</a><button aria-label="Toggle theme" title="Toggle light/dark theme" id=dark-mode-button><div class=theme-toggle-inner><svg viewbox="0 0 24 24" class=sun-icon fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg><svg viewbox="0 0 24 24" class=moon-icon fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>My OpenBSD journey: Getting it virtualized with libvirt (1)</h1><div class=post-meta><div class=meta-line><span class=author>Raffael</span><span class=separator>·</span><time>February 06, 2023</time><span class=separator>·</span><span class=reading-time>10 min read</span></div></div></div></div><img alt="My OpenBSD journey: Getting it virtualized with libvirt (1)" class=post-thumbnail decoding=async loading=lazy src=/openbsd-libvirt.avif></header></article><div class=article-post><h2 id=void-linux-as-my-daily-driver>Void Linux as my daily driver</h2><p>Around six months ago, I decided to ditch my long in the tooth Arch-based setup on my belovest Thinkpad X1 Carbon. I’ve been very loyal over the years, and almost came to belive that Arch will be a constant in my adult life. While I kept up with upcoming technologies, I somehow lost track of the ever so diversifying landscape of Linux distributions. It took me a while of constantly coming across a generically named reference to what seemed to be yet another Linux distribution. That outwardly generic sounding name, <a href=https://voidlinux.org/ rel=noopener target=_blank>Void Linux</a>, kept poking my curiosity by supposedly feeling like Arch Linux in the old days, while sharing some substantial DNA with the BSD operating systems. Yet, that’s another story I might tell another day, but to remain brief, the BSDs, in particular the infamous OpenBSD with its quite infamous lead developer Theo De Raadt, always were what I considered the endgame. The holy grail of Unix operating systems, so did I think over the decades, FreeBSD, NetBSD and OpenBSD, have always been on my personal radar and I felt I had to earn the intellectual capacity to be able to properly put them at use one day. Last year, when I made the (almost painless) switch from Arch Linux to Void Linux, the simplicity and especially the barebone experience of Void reignited the fascination and the admiration I always had for the BSD operating systems and their philosophy.<p>While I could write (and definitely will in the near future) about how my journey onto Void Linux and how it has been so far, I preferred to write down, in some like diary, and document every step on how one can approach and ultimately use <a href=https://www.openbsd.org/ rel=noopener target=_blank>OpenBSD</a> in 2023. Big disclaimer, I’ve yet to install OpenBSD on some baremetal server I ordered some days ago, but dabbled around in the meantime with OS-level virtualization in order to get it running. That’s what brings me to <em>libvirt</em> and my surprise to learn that I wouldn’t need some full-fledged virtualization solution like the ones offered by VirtualBox or VMWare to efficiently run a virtualized OpenBSD machine. So, ok, let’s recap, so far we got the following bill of materials:<ul><li>Void Linux as the host system<li>OpenBSD to be virtualized on that host system<li>libvirt as the glue that makes virtualization feel like black magic</ul><h3 id=from-void-to-openbsd>From Void to OpenBSD</h3><p>Before I tell you more about the history of how things went down while setting up OpenBSD, let me give you some basic notions about both Void Linux, being one out of many Linux distributions for the sake of simplicity representing them all as it ended up being my distribution of choice, and OpenBSD. As already mentioned earlier, Void Linux and OpenBSD are both Unix-like operating systems, but they feature enough differences to make them noteworthy. Here are a few similarities and differences between the two:<p>What is similar:<ul><li>Both are free and open-source operating systems.<li>Both use a package manager for software management. Void Linux uses XBPS, while OpenBSD uses pkg_add.<li>Both prioritize security and stability in their development and design.<li>Both feature a version control based package repository, meaning that changes in build definition are managed by pull requests from users.</ul><p>What is different:<ul><li>License: Void Linux is licensed under the MIT License, while OpenBSD is licensed under the ISC License.<li>Philosophy: OpenBSD prioritizes security and privacy, while Void Linux prioritizes simplicity and modularity.<li>Package Management: Void Linux uses a binary package manager (XBPS), while OpenBSD uses a source-based package manager (pkg_add).<li>Package Repository: Void Linux has a large and diverse repository, while OpenBSD has a smaller and more curated repository.<li>Init System: Void Linux uses runit as its init system, while OpenBSD uses rc. None uses the infamous systemd init system.</ul><h2 id=what-is-openbsd-in-a-nutshell>What is OpenBSD in a nutshell</h2><p>OpenBSD is a free and open-source operating system that focuses on security, standardization, and robustness. It is based on the Berkeley Software Distribution (BSD) Unix operating system and is developed by a global community of volunteers. OpenBSD aims to provide a secure platform for both personal and enterprise use by implementing strong security features, including access control mechanisms, encryption, and auditing.<p><a href=https://en.wikipedia.org/wiki/Theo_de_Raadt rel=noopener target=_blank>Theo de Raadt</a> is the founder and lead developer of OpenBSD. His main objective with OpenBSD is to create a secure operating system that is free from backdoors, vulnerabilities, and other security weaknesses. He is committed to auditing the source code of the operating system and third-party software included with it, to identify and remove any potential security risks. De Raadt is also dedicated to improving the overall quality of the codebase and ensuring compatibility with a wide range of hardware and software.<p>What makes OpenBSD really special and stand out is that is developed a suite of tools that got adopted by other OSs like Linux, macOS or even Windows. One of the most famous instances of such adoption is the now de facto standard openssh suite. It actually emerged from within the development circle of the OpenBSD project. OpenBSD also implemented a wide range of OS features that are by now considered staples among other OSs, things like Linux-based OS-level containerization done via the means of cgroups, something that OpenBSD already pioneered and solved with a different spin many years before Linux with pledge and unveil. Go check out <a href=https://why-openbsd.rocks/fact/freezero/ rel=noopener target=_blank>Why OpenBSD rocks</a> to get a feel what makes OpenBSD so unique and interesting.<h3 id=virtualization-with-libvirt>Virtualization with libvirt</h3><p>So now, let’s get back to our virtualization endeavour where we would like to virtualize OpenBSD on a Void Linux installation. If you happen to be using another Linux distribution, most of the individual steps would be very similar. That brings me to the next technology we should explain a bit more here, and that is libvirt.<p><a href=https://libvirt.org/ rel=noopener target=_blank>libvirt</a> is an open-source virtualization management library that provides a simple and unified API for managing virtualization technologies, including KVM, QEMU, Xen, and others. It aims to simplify the process of creating, managing, and migrating virtual machines, storage, and networks, and to make it easier for administrators to manage virtual environments.<p>To virtualize an operating system like OpenBSD with libvirt, you need to follow these steps:<ol><li>Install libvirt and the virtualization technology you want to use, such as KVM.<li>Download the OpenBSD iso file and place it in a location accessible by libvirt.<li>Create a new virtual machine in libvirt with the OpenBSD ISO as the installation media. This can be done through the command line or using a graphical user interface such as virt-manager.<li>Configure the virtual machine, including the amount of memory, CPU, and disk space, to meet the requirements of OpenBSD.<li>Start the virtual machine and install OpenBSD as you would on a physical machine.<li>Once the installation is complete, you can configure the virtual network, storage, and other settings as required.<li>Finally, you can use the libvirt API or the command line to manage and control the virtual machine, including starting, stopping, migrating, and snapshotting.</ol><h3 id=step-by-step-guide>Step-by-step guide</h3><p>Let’s first install the <code>libvirt</code> package and some related packages which we need in order to connect via VNC. The VNC will provide us with the possibility to use the graphical interface of the running OpenBSD instance.<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> sudo xbps-install -S dbus qemu libvirt virt-manager virt-viewer tigervnc
</span></code></pre><p>Now, we need to add our user, in my case <code>raskell</code>, to the <code>libvirt</code> group which got simultanously created with the installation of libvirt.<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> sudo usermod -aG libvirt raskell
</span></code></pre><p>OpenBSD features a release cycle of six months. We would need to update our system every six month to keep up with the latest packages. During a given release, only security and bug fix patches are applied to the curated packages maintained by pkg_add. Therefore, in February 2023, we’re using the <a href=https://www.openbsd.org/72.html rel=noopener target=_blank>OpenBSD 7.2</a> release version. As I’m living in Switzerland, I chose to pull the iso image from a Swiss mirror, in this case from <a href=https://mirror.ungleich.ch/pub/OpenBSD/7.2/ rel=noopener target=_blank><code>mirror.ungleich.ch/pub/OpenBSD</code></a> (check what mirror is closest to you to get the best download rate).<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#616e88># cd /var/lib/libvirt/boot/
</span><span style=color:#616e88># sudo wget https://mirror.ungleich.ch/pub/OpenBSD/7.2/amd64/install72.iso
</span><span style=color:#88c0d0>--2023-01-12</span><span> 20:48:15--  https://mirror.ungleich.ch/pub/OpenBSD/7.2/amd64/install72.iso
</span><span style=color:#88c0d0>Resolving</span><span> mirror.ungleich.ch (mirror.ungleich.ch)</span><span style=color:#88c0d0>...</span><span> 2a0a:e5c0:2:2:400:c8ff:fe68:bef3, 185.203.114.135
</span><span style=color:#88c0d0>Connecting</span><span> to mirror.ungleich.ch (mirror.ungleich.ch)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0>2a0a:e5c0:2:2:400:c8ff:fe68:bef3</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0>:443...</span><span> connected.
</span><span style=color:#88c0d0>HTTP</span><span> request sent, awaiting response... 200 OK
</span><span style=color:#88c0d0>Length:</span><span> 583352320 (556M) </span><span style=color:#88c0d0>[application/octet-stream]
</span><span style=color:#88c0d0>Saving</span><span> to: ‘install72.iso.1’
</span><span>
</span><span style=color:#88c0d0>install72.iso.1</span><span>                      100</span><span style=color:#81a1c1>%[</span><span>====================================================================></span><span style=color:#81a1c1>]</span><span> 556.33M  7.11MB/s    in 77s     
</span><span>
</span><span style=color:#88c0d0>2023-01-12</span><span> 20:49:33 (7.19 MB/s) </span><span style=color:#88c0d0>-</span><span> ‘install72.iso.1’ saved </span><span style=color:#81a1c1>[</span><span>583352320/583352320</span><span style=color:#81a1c1>]
</span><span style=color:#88c0d0>sudo</span><span> wget https://mirror.ungleich.ch/pub/OpenBSD/7.2/amd64/SHA256
</span><span style=color:#88c0d0>--2023-01-12</span><span> 20:47:38--  https://mirror.ungleich.ch/pub/OpenBSD/7.2/amd64/SHA256
</span><span style=color:#88c0d0>Resolving</span><span> mirror.ungleich.ch (mirror.ungleich.ch)</span><span style=color:#88c0d0>...</span><span> 2a0a:e5c0:2:2:400:c8ff:fe68:bef3, 185.203.114.135
</span><span style=color:#88c0d0>Connecting</span><span> to mirror.ungleich.ch (mirror.ungleich.ch)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0>2a0a:e5c0:2:2:400:c8ff:fe68:bef3</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0>:443...</span><span> connected.
</span><span style=color:#88c0d0>HTTP</span><span> request sent, awaiting response... 200 OK
</span><span style=color:#88c0d0>Length:</span><span> 1992 (1.9K) </span><span style=color:#88c0d0>[application/octet-stream]
</span><span style=color:#88c0d0>Saving</span><span> to: ‘SHA256.1’
</span><span>
</span><span style=color:#88c0d0>SHA256.1</span><span>                             100</span><span style=color:#81a1c1>%[</span><span>====================================================================></span><span style=color:#81a1c1>]</span><span>   1.95K  --.-KB/s    in 0s      
</span><span>
</span><span style=color:#88c0d0>2023-01-12</span><span> 20:47:39 (742 MB/s) </span><span style=color:#88c0d0>-</span><span> ‘SHA256.1’ saved </span><span style=color:#81a1c1>[</span><span>1992/1992</span><span style=color:#81a1c1>]
</span><span style=color:#616e88># grep install63.iso SHA256 > /tmp/x
</span><span style=color:#616e88># sha256sum -c /tmp/x
</span><span style=color:#616e88># rm /tmp/x
</span></code></pre><p>Before we can start the virtualization server and get running our OpenBSD instance, we need to define the configuraiton on how to virtualize and ultimately boot the system with. This is done with <code>virt-install</code>. Noteworthy here is that we <a href=https://www.qemu.org/ rel=noopener target=_blank>QEMU</a> as our emulation solution of choice, we allocate up to 4GB of RAM and 4 CPU cores to the machine.<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> sudo virt-install </span><span style=color:#81a1c1>\
</span><span>      --name</span><span style=color:#81a1c1>=</span><span>openbsd </span><span style=color:#81a1c1>\
</span><span>      --virt-type</span><span style=color:#81a1c1>=</span><span>qemu </span><span style=color:#81a1c1>\
</span><span>      --memory</span><span style=color:#81a1c1>=</span><span>2048,maxmemory=4096 </span><span style=color:#81a1c1>\
</span><span>      --vcpus</span><span style=color:#81a1c1>=</span><span>2,maxvcpus=4 </span><span style=color:#81a1c1>\
</span><span>      --cpu host </span><span style=color:#81a1c1>\
</span><span>      --os-variant</span><span style=color:#81a1c1>=</span><span>openbsd7.0 </span><span style=color:#81a1c1>\
</span><span>      --cdrom</span><span style=color:#81a1c1>=</span><span>/var/lib/libvirt/boot/install72.iso </span><span style=color:#81a1c1>\
</span><span>      --network</span><span style=color:#81a1c1>=</span><span>bridge=virbr0,model=virtio </span><span style=color:#81a1c1>\
</span><span>      --graphics</span><span style=color:#81a1c1>=</span><span>vnc </span><span style=color:#81a1c1>\
</span><span>      --disk path=/var/lib/libvirt/images/openbsd.qcow2,size=40,bus=virtio,format=qcow2
</span></code></pre><p>Once, it is up and running, we can use a vnc solution to connect to the running machine. In this case, I chose <a href=https://www.libvirt.org/manpages/virsh.html rel=noopener target=_blank>virsh</a> to do the job. virsh is a command-line interface tool for managing virtualization environments created with libvirt. It allows us to manage virtual machines, storage pools, and network interfaces, as well as other virtualization components, from the command line.<p>To establish a VNC connection with a running libvirt virtualized OpenBSD instance, you can use the following steps:<ol><li>Start the virtual machine in libvirt: You can start the virtual machine using the virsh command <strong><code>virsh start &LTvm-name></code></strong>, where <strong><code>&LTvm-name></code></strong> is the name of the virtual machine you want to start.<li>Find the VNC display: Once the virtual machine is running, you can find the VNC display number for the virtual machine using the virsh command <strong><code>virsh vncdisplay &LTvm-name></code></strong>.<li>Connect to the VNC display: You can connect to the VNC display using a VNC client, such as <strong><code>vncviewer</code></strong>, and specify the IP address of the host running the virtual machine and the VNC display number. For example, if the host’s IP address is <strong><code>192.168.0.100</code></strong> and the VNC display number is <strong><code>:0</code></strong>, the command to connect would be <strong><code>vncviewer 192.168.0.100:0</code></strong>.<li>Authenticate to the VNC server: You may need to enter a password to authenticate to the VNC server. The password is set when the virtual machine is created in libvirt.</ol><p>With these steps, you can establish a VNC connection with a running libvirt virtualized OpenBSD instance and interact with the virtual machine’s graphical user interface.<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> virsh dumpxml openbsd </span><span style=color:#81a1c1>| </span><span style=color:#88c0d0>grep</span><span> vnc
</span><span style=color:#81a1c1><</span><span>graphics type</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'vnc' </span><span>port</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'5900' </span><span>autoport</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'yes' </span><span>listen</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'127.0.0.1'</span><span style=color:#81a1c1>>
</span></code></pre><p>Like I did, most of you would like to interact with a graphical interface such as with X11. For that, we yet another tool, a so-called VNC viewer. A very simple implementation of such a vnc viewer is <a href=https://tigervnc.org/ rel=noopener target=_blank>tigervnc</a> (simply install it with <code>$ sudo xbps-install -S tigervnc</code>).<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> sudo virsh --connect
</span><span style=color:#88c0d0>qemu:///system</span><span> start openbsd
</span><span style=color:#88c0d0>Domain </span><span style=color:#a3be8c>'openbsd'</span><span> started
</span></code></pre><p>{tbc}<h2 id=references-and-further-reading>References and further reading</h2><ul><li><a href=https://www.reddit.com/r/voidlinux/comments/ghwvv5/guide_how_to_setup_qemukvm_emulation_on_void_linux/ rel=noopener target=_blank>[Guide] how to setup QEMU/KVM emulation on void linux | /r/voidlinux</a><li><a href=https://www.cyberciti.biz/faq/kvmvirtualization-virt-install-openbsd-unix-guest/ rel=noopener target=_blank>KVM virt-install: Install OpenBSD As Guest Operating System</a><li><a href=https://www.skreutz.com/posts/autoinstall-openbsd-on-qemu/ rel=noopener target=_blank>Auto-install OpenBSD on QEMU | skreutz.com</a></ul></div></div><div class=container><nav class="flex container suggested"><a title="Previous post (older)" href=https://raskell.io/articles/all-beginning-is-haskell/ rel=prev> <span>← Previous</span> <strong>All beginning is Haskell</strong> </a><a title="Next post (newer)" href=https://raskell.io/articles/hello-and-outlook/ rel=next> <span>Next →</span> <strong>Hello and outlook</strong> </a></nav></div></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=https://raskell.io/rss.xml>RSS</a></nav></section><script src=https://raskell.io/app.js></script></footer><script src=https://raskell.io/anchors.js></script><script src=https://raskell.io/scroll-to-top.js></script>